<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Åß„Çì„Åü„ÅèÔºã ÊúÄÁµÇÁâà</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<style>
body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; margin:0; padding:0; }
.top-bar { display:flex; align-items:center; justify-content:space-between; width:400px; margin-top:20px; }
#title { font-size:24px; margin:0 10px; }
#calcInput { font-size:24px; width:380px; text-align:right; margin-top:10px; padding:5px; z-index:50; }
#calculator { display:grid; grid-template-columns:repeat(4,80px); gap:5px; margin-top:10px; }
button { font-size:20px; padding:15px; }
.popup { position:absolute; background:#fff; border:1px solid #ccc; padding:10px; z-index:100; display:none; max-height:200px; overflow-y:auto; }
#searchResults { width:380px; position:absolute; background:#fff; border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; z-index:49; } 
#searchResults div { padding:5px; cursor:pointer; }
#searchResults div:hover { background:#eee; }
#searchContainer { position:relative; width:380px; margin-top:10px; }
</style>
</head>
<body>

<div class="top-bar">
  <button id="formulaBtn">„ÅÑ„Çç„ÅÑ„Çç„Å™Âºè</button>
  <div id="title">„Åß„Çì„Åü„ÅèÔºã</div>
  <button id="historyBtn">üïí</button>
</div>

<div id="searchContainer">
  <input type="text" id="calcInput" placeholder="„Åì„Åì„Å´Ë®àÁÆóÂºè„ÉªÂÖ¨ÂºèÂêç„ÇíÂÖ•Âäõ">
  <div id="searchResults"></div>
</div>

<div id="calculator">
  <button id="AC">AC</button>
  <button>(</button>
  <button>)</button>
  <button>√∑</button>

  <button>7</button>
  <button>8</button>
  <button>9</button>
  <button>√ó</button>

  <button>4</button>
  <button>5</button>
  <button>6</button>
  <button>‚àí</button>

  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>Ôºã</button>

  <button>0</button>
  <button>.</button>
  <button id="backspace">‚å´</button>
  <button id="equal">=</button>
</div>

<div id="formulaPopup" class="popup"></div>
<div id="historyPopup" class="popup"></div>

<script>
const calcInput = document.getElementById("calcInput");
const searchResults = document.getElementById("searchResults");

// ÂÖ¨Âºè„Éá„Éº„ÇøÔºàÂêçÂâç„Å®Âºè„ÄÅ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ªò„ÅçÔºâ
const formulas = [
  {name:"Ê≠£Âº¶Èñ¢Êï∞", expr:"sin([x])"},
  {name:"‰ΩôÂº¶Èñ¢Êï∞", expr:"cos([x])"},
  {name:"Ê≠£Êé•Èñ¢Êï∞", expr:"tan([x])"},
  {name:"ÂØæÊï∞Èñ¢Êï∞", expr:"log([x])"},
  {name:"Ëá™ÁÑ∂ÂØæÊï∞", expr:"ln([x])"},
  {name:"Âπ≥ÊñπÊ†π", expr:"sqrt([x])"},
  {name:"„Éî„Çø„Ç¥„É©„Çπ„ÅÆÂÆöÁêÜ", expr:"[a]^2+[b]^2=[c]^2"},
  {name:"‰∫åÊ¨°ÊñπÁ®ãÂºè", expr:"(-[b]+sqrt([b]^2-4*[a]*[c]))/(2*[a])"},
  {name:"ÈÅãÂãï„ÅÆÊ≥ïÂâá", expr:"F=[m]*[a]"},
  {name:"Ë≥™Èáè„Ç®„Éç„É´„ÇÆ„ÉºÁ≠â‰æ°", expr:"E=[m]*c^2"}
];

// „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂØæÂøú„Ç´„Éº„ÇΩ„É´ÈÖçÁΩÆ
function focusFirstPlaceholder(){
  const val = calcInput.value;
  const phPos = val.indexOf("[");
  if(phPos !== -1){
    const endPos = val.indexOf("]", phPos);
    calcInput.setSelectionRange(phPos+1,endPos);
  } else {
    const pos = val.length;
    calcInput.setSelectionRange(pos,pos);
  }
  calcInput.focus();
}

// ÂÖ¨ÂºèÈÅ∏ÊäûÊôÇ„Å´„Éê„Éº„Å´Ë°®Á§∫
function selectFormula(f){
  calcInput.value = f.expr;
  focusFirstPlaceholder();
}

// ÈÄöÂ∏∏ÊñáÂ≠óÊåøÂÖ•
function insertAtCursor(text){
  const start=calcInput.selectionStart;
  const end=calcInput.selectionEnd;
  const val=calcInput.value;
  calcInput.value=val.slice(0,start)+text+val.slice(end);
  calcInput.setSelectionRange(start+text.length,start+text.length);
  calcInput.focus();
}

// ÈõªÂçì„Éú„Çø„É≥
document.getElementById("AC").addEventListener("click",()=>calcInput.value="");
document.getElementById("backspace").addEventListener("click",()=>{
  const start=calcInput.selectionStart;
  const end=calcInput.selectionEnd;
  if(start!==end){
    calcInput.value=calcInput.value.slice(0,start)+calcInput.value.slice(end);
    calcInput.setSelectionRange(start,start);
  } else if(start>0){
    calcInput.value=calcInput.value.slice(0,start-1)+calcInput.value.slice(start);
    calcInput.setSelectionRange(start-1,start-1);
  }
  calcInput.focus();
});
document.querySelectorAll("#calculator button").forEach(btn=>{
  const val=btn.textContent;
  if(["AC","‚å´","="].includes(val)) return;
  btn.addEventListener("click",()=>insertAtCursor(val));
});

// Ë®àÁÆó
const history=[];
document.getElementById("equal").addEventListener("click",()=>{
  try{
    let expr=calcInput.value.replace(/√ó/g,"*").replace(/√∑/g,"/").replace(/‚àí/g,"-").replace(/Ôºã/g,"+");
    // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Å´Êï∞Â≠ó„ÅåÂÖ•„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÁΩÆÊèõ„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØ0
    expr = expr.replace(/\[([^\]]*?)\]/g,(m,p)=>{ 
      const n=parseFloat(p); 
      return isNaN(n)?0:n; 
    });
    const result = math.evaluate(expr);
    history.push(calcInput.value+" = "+result);
    calcInput.value = result;
  } catch(e){ calcInput.value="Error"; }
});

// „ÅÑ„Çç„ÅÑ„Çç„Å™Âºè„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºà6ÂÄã„ÅÆ„Åø„ÄÅÊã¨Âºß‰øÆÊ≠£Ôºâ
const formulaPopup=document.getElementById("formulaPopup");
const formulaBtn=document.getElementById("formulaBtn");
const preset6 = formulas.slice(0,6);
preset6.forEach(f=>{
  const b=document.createElement("button");
  // ‰øÆÊ≠£: ‰∏≠Ë∫´„ÅØÁ©∫„ÅÆÊã¨Âºß„Å†„ÅëË°®Á§∫
  b.textContent = f.expr.replace(/\[.*?\]/g,"");
  b.style.margin="3px";
  b.onclick=()=>{ selectFormula(f); formulaPopup.style.display="none"; };
  formulaPopup.appendChild(b);
});
formulaBtn.addEventListener("click",()=>formulaPopup.style.display=formulaPopup.style.display==="none"?"block":"none");

// Â±•Ê≠¥
const historyPopup=document.getElementById("historyPopup");
const historyBtn=document.getElementById("historyBtn");
historyBtn.addEventListener("click",()=>{
  historyPopup.innerHTML="";
  if(history.length===0){ historyPopup.textContent="Â±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì"; }
  else{
    history.slice().reverse().forEach(item=>{
      const div=document.createElement("div");
      div.textContent=item;
      div.style.padding="5px";
      div.style.cursor="pointer";
      div.addEventListener("click",()=>{ calcInput.value=item.split(" = ")[0]; historyPopup.style.display="none"; focusFirstPlaceholder(); });
      historyPopup.appendChild(div);
    });
  }
  historyPopup.style.display = historyPopup.style.display==="none"?"block":"none";
});

// Ê§úÁ¥¢‰∫àÊ∏¨
calcInput.addEventListener("input",()=>{
  const q=calcInput.value.trim().toLowerCase();
  searchResults.innerHTML="";
  if(q===""){ searchResults.style.display="none"; return; }
  const matches=formulas.filter(f=>f.name.toLowerCase().includes(q) || f.expr.toLowerCase().includes(q)).slice(0,15);
  matches.forEach(f=>{
    const div=document.createElement("div");
    div.textContent=f.name + " ‚Üí " + f.expr;
    div.onclick=()=>{ selectFormula(f); searchResults.style.display="none"; };
    searchResults.appendChild(div);
  });
  searchResults.style.display = matches.length>0?"block":"none";
});

// Â§ñ„ÇØ„É™„ÉÉ„ÇØ„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÈñâ„Åò„Çã
document.addEventListener("click",(e)=>{
  if(!historyPopup.contains(e.target)&&e.target!==historyBtn) historyPopup.style.display="none";
  if(!formulaPopup.contains(e.target)&&e.target!==formulaBtn) formulaPopup.style.display="none";
  if(!searchResults.contains(e.target)&&e.target!==calcInput) searchResults.style.display="none";
});
</script>
</body>
</html>
