<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã§ã‚“ãŸãï¼‹ æœ€çµ‚ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<style>
body { 
  font-family:sans-serif; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  margin:0; 
  padding:10px; 
  max-width: 100%;
}
.top-bar { 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  width:100%; 
  max-width:400px; 
  margin-top:20px; 
  flex-wrap: nowrap;       /* â† æ¨ªä¸¦ã³ã‚’å¼·åˆ¶ */
}
#title { 
  font-size:24px; 
  margin:0 10px; 
  white-space: nowrap;     /* â† æŠ˜ã‚Šè¿”ã•ãšæ¨ªã«è¡¨ç¤º */
}
#calcInput { font-size:24px; width:100%; text-align:right; margin-top:10px; padding:5px; z-index:50; }
#calculator { 
  display:grid; 
  grid-template-columns:repeat(4, 20%); 
  gap:5px; 
  margin-top:10px; 
  width:100%;
  max-width:400px;
}
button { 
  font-size:20px; 
  padding:15px; 
  width:100%;  
  box-sizing:border-box;
}
.popup { 
  position:absolute; 
  background:#fff; 
  border:1px solid #ccc; 
  padding:10px; 
  z-index:100; 
  display:none; 
  max-height:200px; 
  overflow-y:auto; 
}
#searchResults { 
  width:100%; 
  max-width:380px; 
  position:absolute; 
  background:#fff; 
  border:1px solid #ccc; 
  display:none; 
  max-height:150px; 
  overflow-y:auto; 
  z-index:49; 
} 
#searchResults div { padding:5px; cursor:pointer; }
#searchResults div:hover { background:#eee; }
#searchContainer { position:relative; width:100%; max-width:380px; margin-top:10px; }
</style>
</head>
<body>

<div class="top-bar">
  <button id="formulaBtn">ã„ã‚ã„ã‚ãªå¼</button>
  <div id="title">ã§ã‚“ãŸãï¼‹</div>
  <button id="historyBtn">ğŸ•’</button>
</div>

<div id="searchContainer">
  <input type="text" id="calcInput" placeholder="ã“ã“ã«è¨ˆç®—å¼ãƒ»å…¬å¼åã‚’å…¥åŠ›">
  <div id="searchResults"></div>
</div>

<div id="calculator">
  <button id="AC">AC</button>
  <button>(</button>
  <button>)</button>
  <button>Ã·</button>

  <button>7</button>
  <button>8</button>
  <button>9</button>
  <button>Ã—</button>

  <button>4</button>
  <button>5</button>
  <button>6</button>
  <button>âˆ’</button>

  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>ï¼‹</button>

  <button>0</button>
  <button>.</button>
  <button id="backspace">âŒ«</button>
  <button id="equal">=</button>
</div>

<div id="formulaPopup" class="popup"></div>
<div id="historyPopup" class="popup"></div>

<script>
const calcInput = document.getElementById("calcInput");
const searchResults = document.getElementById("searchResults");

const formulas = [
  {name:"æ­£å¼¦é–¢æ•°", expr:"sin([x])"},
  {name:"ä½™å¼¦é–¢æ•°", expr:"cos([x])"},
  {name:"æ­£æ¥é–¢æ•°", expr:"tan([x])"},
  {name:"å¯¾æ•°é–¢æ•°", expr:"log([x])"},
  {name:"è‡ªç„¶å¯¾æ•°", expr:"ln([x])"},
  {name:"å¹³æ–¹æ ¹", expr:"sqrt([x])"},
  {name:"ãƒ”ã‚¿ã‚´ãƒ©ã‚¹ã®å®šç†", expr:"[a]^2+[b]^2=[c]^2"},
  {name:"äºŒæ¬¡æ–¹ç¨‹å¼", expr:"(-[b]+sqrt([b]^2-4*[a]*[c]))/(2*[a])"},
  {name:"é‹å‹•ã®æ³•å‰‡", expr:"F=[m]*[a]"},
  {name:"è³ªé‡ã‚¨ãƒãƒ«ã‚®ãƒ¼ç­‰ä¾¡", expr:"E=[m]*c^2"}
];

function focusFirstPlaceholder(){
  const val = calcInput.value;
  const phPos = val.indexOf("[");
  if(phPos !== -1){
    const endPos = val.indexOf("]", phPos);
    calcInput.setSelectionRange(phPos+1,endPos);
  } else {
    const pos = val.length;
    calcInput.setSelectionRange(pos,pos);
  }
  calcInput.focus();
}

function selectFormula(f){
  calcInput.value = f.expr;
  focusFirstPlaceholder();
}

function insertAtCursor(text){
  const start=calcInput.selectionStart;
  const end=calcInput.selectionEnd;
  const val=calcInput.value;
  calcInput.value=val.slice(0,start)+text+val.slice(end);
  calcInput.setSelectionRange(start+text.length,start+text.length);
  calcInput.focus();
}

document.getElementById("AC").addEventListener("click",()=>calcInput.value="");
document.getElementById("backspace").addEventListener("click",()=>{
  const start=calcInput.selectionStart;
  const end=calcInput.selectionEnd;
  if(start!==end){
    calcInput.value=calcInput.value.slice(0,start)+calcInput.value.slice(end);
    calcInput.setSelectionRange(start,start);
  } else if(start>0){
    calcInput.value=calcInput.value.slice(0,start-1)+calcInput.value.slice(start);
    calcInput.setSelectionRange(start-1,start-1);
  }
  calcInput.focus();
});
document.querySelectorAll("#calculator button").forEach(btn=>{
  const val=btn.textContent;
  if(["AC","âŒ«","="].includes(val)) return;
  btn.addEventListener("click",()=>insertAtCursor(val));
});

const history=[];
document.getElementById("equal").addEventListener("click",()=>{
  try{
    let expr=calcInput.value.replace(/Ã—/g,"*").replace(/Ã·/g,"/").replace(/âˆ’/g,"-").replace(/ï¼‹/g,"+");
    expr = expr.replace(/\[([^\]]*?)\]/g,(m,p)=>{ 
      const n=parseFloat(p); 
      return isNaN(n)?0:n; 
    });
    const result = math.evaluate(expr);
    history.push(calcInput.value+" = "+result);
    calcInput.value = result;
  } catch(e){ calcInput.value="Error"; }
});

const formulaPopup=document.getElementById("formulaPopup");
const formulaBtn=document.getElementById("formulaBtn");
const preset6 = formulas.slice(0,6);
preset6.forEach(f=>{
  const b=document.createElement("button");
  b.textContent = f.expr.replace(/\[.*?\]/g,"");
  b.style.margin="3px";
  b.onclick=()=>{ selectFormula(f); formulaPopup.style.display="none"; };
  formulaPopup.appendChild(b);
});
formulaBtn.addEventListener("click",()=>formulaPopup.style.display=formulaPopup.style.display==="none"?"block":"none");

const historyPopup=document.getElementById("historyPopup");
const historyBtn=document.getElementById("historyBtn");
historyBtn.addEventListener("click",()=>{
  historyPopup.innerHTML="";
  if(history.length===0){ historyPopup.textContent="å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“"; }
  else{
    history.slice().reverse().forEach(item=>{
      const div=document.createElement("div");
      div.textContent=item;
      div.style.padding="5px";
      div.style.cursor="pointer";
      div.addEventListener("click",()=>{ calcInput.value=item.split(" = ")[0]; historyPopup.style.display="none"; focusFirstPlaceholder(); });
      historyPopup.appendChild(div);
    });
  }
  historyPopup.style.display = historyPopup.style.display==="none"?"block":"none";
});

calcInput.addEventListener("input",()=>{
  const q=calcInput.value.trim().toLowerCase();
  searchResults.innerHTML="";
  if(q===""){ searchResults.style.display="none"; return; }
  const matches=formulas.filter(f=>f.name.toLowerCase().includes(q) || f.expr.toLowerCase().includes(q)).slice(0,15);
  matches.forEach(f=>{
    const div=document.createElement("div");
    div.textContent=f.name + " â†’ " + f.expr;
    div.onclick=()=>{ selectFormula(f); searchResults.style.display="none"; };
    searchResults.appendChild(div);
  });
  searchResults.style.display = matches.length>0?"block":"none";
});

document.addEventListener("click",(e)=>{
  if(!historyPopup.contains(e.target)&&e.target!==historyBtn) historyPopup.style.display="none";
  if(!formulaPopup.contains(e.target)&&e.target!==formulaBtn) formulaPopup.style.display="none";
  if(!searchResults.contains(e.target)&&e.target!==calcInput) searchResults.style.display="none";
});
</script>
</body>
</html>



